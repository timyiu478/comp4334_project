<html>
    <body>
        <input id="receiver" name="receiver">
        <textarea id="message" rows="4" cols="50"></textarea>
        <button onclick="sendMsg()">Send</button>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/cryptico/0.0.1343522940/cryptico.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/cryptico/0.0.1343522940/rsa.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/cryptico/0.0.1343522940/api.min.js"></script>
        <script type="text/javascript" src="https://cdn.rawgit.com/ricmoo/aes-js/e27b99df/index.js"></script>

        <script>
            var socket = io.connect('https://' + document.domain + ':' + location.port);

            let MattsRSAkey = JSON.parse(localStorage.getItem('MattsRSAkey'));
            let MattsPublicKeyString = cryptico.publicKeyString(MattsRSAkey);  

            socket.on('connect', function(data) {
                console.log(data);
                socket.emit('join', {});
            });

            socket.on('all',function(data){
                console.log(data);
            })

            socket.on('message',function(data){
                console.log(data);
                let encryptedBytes = aesjs.utils.hex.toBytes(data['data']['msg']);

                let aes = JSON.parse(data['data']['aes']);
                console.log(aes['key']);
                console.log(aes['iv']);
                let aesCbc = new aesjs.ModeOfOperation.cbc(aes['key'], aes['iv']);

                let decryptedBytes = aesCbc.decrypt(encryptedBytes);
                let decryptedText = aesjs.utils.utf8.fromBytes(decryptedBytes);

                let msg = decryptedText.slice(0,data['data']['msg_length']);
                console.log(msg);

            });

            function padding(msg){
                if(msg.length % 16 != 0){
                    count = msg.length % 16;
                    console.log(count);
                    let array = new Uint8Array(16-count);
                    array = crypto.getRandomValues(array);
                    console.log(array); 
                    pad = "";
                    for (var i = 0; i < array.length; i++) {
                        pad += String.fromCharCode((array[i]+32)%127);
                    }
                    console.log(msg+pad);
                    return msg+pad;
                }
                else{
                    return msg;
                }
            }

            function sendMsg(){

                let to = document.getElementById('receiver').value;
                let msg = document.getElementById('message').value;

                let key_256 = crypto.getRandomValues(new Uint8Array(32));
                let iv = crypto.getRandomValues(new Uint8Array(16));

                let msgBytes = aesjs.utils.utf8.toBytes(padding(msg));


                let aesCbc = new aesjs.ModeOfOperation.cbc(key_256, iv);
                let encryptedBytes = aesCbc.encrypt(msgBytes);

                let encryptedHex = aesjs.utils.hex.fromBytes(encryptedBytes);
                console.log(encryptedHex);
               
                aes = {
                    'key_256':key_256,
                    'iv': iv
                }

                data = {
                    'to': to,
                    'msg': encryptedHex,
                    'msg_length': msg.length,
                    'aes': JSON.stringify(aes) 
                }



                socket.emit('message', data);
                document.getElementById('receiver').value = "";
                document.getElementById('message').value = "";
            }

        </script>
    </body>
</html>